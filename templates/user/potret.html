<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ambil Foto Wajah - Registrasi</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body {
      background:#f5f5f5; min-height:100vh;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; padding:30px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;
      width:100%; max-width:450px;
    }
    h2 {
      font-size:24px; margin-bottom:20px; color:#333;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    h2::before { content:"üì∑"; font-size:28px; }
    .student-info {
      background:#e7f3ff; padding:15px; border-radius:6px;
      margin-bottom:20px; border-left:4px solid #007bff;
      text-align:left;
    }
    .student-info h3 { color:#333; font-size:16px; margin-bottom:8px; }
    .student-info p { color:#555; font-size:14px; margin:4px 0; }
    .info-text {
      color:#666; font-size:14px; margin-bottom:20px;
      padding:12px; background:#fff3cd; border-radius:6px;
      border-left:3px solid #ffc107;
    }
    .camera-section {
      margin-bottom:20px;
    }
   video {
    width:100%; max-width:350px; border-radius:6px; margin-bottom:15px;
    border:2px solid #28a745; display:none;
    transform: scaleX(-1); /* Mirror horizontal */
    -webkit-transform: scaleX(-1); /* Safari */
  }
  video.active {
    display:block;
  }
    input[type="file"] {
      width:100%; padding:12px; border:1px solid #ddd;
      border-radius:6px; margin-bottom:15px; background:#f8f9fa;
    }
    button {
      width:100%; padding:14px; border:none;
      border-radius:6px; font-size:16px; font-weight:600;
      background:#28a745; color:#fff; cursor:pointer; transition:.3s;
      margin-bottom:10px;
    }
    button:hover:not(:disabled) {
      background:#1e7e34; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(40,167,69,0.3);
    }
    button:disabled { background:#6c757d; cursor:not-allowed; }
    button.secondary {
      background:#007bff;
    }
    button.secondary:hover:not(:disabled) {
      background:#0056b3;
      box-shadow:0 4px 12px rgba(0,123,255,0.3);
    }
    .back-link { margin-top:15px; }
    .back-link a { color:#007bff; text-decoration:none; font-size:14px; }
    .back-link a:hover { color:#0056b3; }
    canvas { display:none; }
    .upload-methods {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ambil Foto Wajah</h2>
    
    <div class="student-info">
      <h3>üìù Data Siswa:</h3>
      <p><strong>Nama:</strong> {{ siswa.nama }}</p>
      <p><strong>Kelas:</strong> {{ siswa.kelas }}</p>
      <p><strong>Jurusan:</strong> {{ siswa.jurusan }}</p>
    </div>
    
    <div class="info-text">
      <strong>Petunjuk:</strong><br>
      Ambil foto wajah yang jelas untuk registrasi. Pastikan hanya ada 1 wajah dalam foto dan pencahayaan cukup.
    </div>

    <div class="camera-section">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="upload-methods">
      <button id="openCamera" class="secondary">üì∑ Buka Kamera</button>
      
      <form id="uploadForm" method="POST" enctype="multipart/form-data" style="display:none;">
        <input type="file" name="foto" accept="image/*" capture="user" required>
        <button type="submit">üìÅ Upload dari Galeri</button>
      </form>
      
      <button id="captureBtn" style="display:none;" disabled>üì∏ Ambil Foto</button>
      <button id="uploadFromGallery">üìÅ Pilih dari Galeri</button>
    </div>
    
    <div class="back-link">
      <a href="{{ url_for('register_user') }}">‚Üê Kembali ke Form Registrasi</a>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const openCameraBtn = document.getElementById('openCamera');
    const captureBtn = document.getElementById('captureBtn');
    const uploadFormGalleryBtn = document.getElementById('uploadFromGallery');
    const uploadForm = document.getElementById('uploadForm');

    let stream = null;

    // Buka kamera
    openCameraBtn.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "user" } 
        });
        video.srcObject = stream;
        video.classList.add('active');
        
        openCameraBtn.style.display = 'none';
        captureBtn.style.display = 'block';
        captureBtn.disabled = false;
        uploadFormGalleryBtn.style.display = 'none';
      } catch(err) {
        console.error("Kamera error:", err);
        Swal.fire("Kamera Error", "Tidak bisa mengakses kamera. Gunakan upload dari galeri.", "warning");
      }
    };

    // Upload dari galeri
    uploadFormGalleryBtn.onclick = () => {
      uploadForm.style.display = 'block';
      openCameraBtn.style.display = 'none';
      uploadFormGalleryBtn.style.display = 'none';
    };

    // Ambil foto dari kamera
  captureBtn.onclick = async () => {
    if (!stream) return;

    captureBtn.disabled = true;
    captureBtn.textContent = "üì∑ Memproses...";

    try {
      // ============= FIX MIRROR SAAT CAPTURE =============
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Flip horizontal agar hasil foto normal
      context.translate(canvas.width, 0);
      context.scale(-1, 1);
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Reset transformasi
      context.setTransform(1, 0, 0, 1, 0, 0);
      // ===================================================

      // Konversi ke blob
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('foto', blob, 'foto_wajah.jpg');

        try {
          const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            Swal.fire({
              icon: 'success',
              title: 'Registrasi Berhasil!',
              text: 'Foto wajah berhasil disimpan. Anda sekarang bisa melakukan absensi.',
              confirmButtonText: 'OK'
            }).then(() => {
              window.location.href = "{{ url_for('index') }}";
            });
          } else {
            const text = await response.text();
            Swal.fire('Error', 'Gagal menyimpan foto: ' + text, 'error');
          }
        } catch(err) {
          console.error(err);
          Swal.fire('Error', 'Gagal mengirim foto ke server', 'error');
        }
      }, 'image/jpeg', 0.95);

    } catch(err) {
      console.error(err);
      Swal.fire('Error', 'Gagal mengambil foto', 'error');
    } finally {
      setTimeout(() => {
        captureBtn.disabled = false;
        captureBtn.textContent = "üì∏ Ambil Foto";
      }, 2000);
    }
  };
  
    // Cleanup ketika pindah halaman
    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>
</html>