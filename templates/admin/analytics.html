<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { background:#f5f5f5; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }
        
        header { 
            background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; 
            box-shadow:0 2px 10px rgba(0,0,0,0.1); border:1px solid #ddd;
        }
        h1 { color:#333; margin-bottom:10px; font-size:1.8rem; }
        .breadcrumb { color:#666; font-size:14px; }
        .breadcrumb a { color:#007bff; text-decoration:none; }
        .breadcrumb a:hover { text-decoration:underline; }
        
        .stats-grid { 
            display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); 
            gap:20px; margin-bottom:30px; 
        }
        .stat-card { 
            background:#fff; padding:20px; border-radius:10px; 
            box-shadow:0 2px 10px rgba(0,0,0,0.1); border:1px solid #ddd;
            transition:transform 0.3s ease;
        }
        .stat-card:hover { transform:translateY(-5px); }
        .stat-number { font-size:2.5rem; font-weight:bold; color:#007bff; margin-bottom:5px; }
        .stat-label { color:#666; font-size:14px; text-transform:uppercase; }
        .stat-change { font-size:12px; margin-top:5px; }
        .stat-change.positive { color:#28a745; }
        .stat-change.negative { color:#dc3545; }
        
        .chart-grid { 
            display:grid; grid-template-columns:repeat(auto-fit, minmax(400px, 1fr)); 
            gap:20px; margin-bottom:30px; 
        }
        .chart-card { 
            background:#fff; padding:20px; border-radius:10px; 
            box-shadow:0 2px 10px rgba(0,0,0,0.1); border:1px solid #ddd;
        }
        .chart-card h3 { margin-bottom:15px; color:#333; font-size:1.1rem; }
        
        .table-card { 
            background:#fff; padding:20px; border-radius:10px; 
            box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:20px; border:1px solid #ddd;
        }
        .table-card h3 { margin-bottom:15px; color:#333; font-size:1.1rem; }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            margin-bottom: 10px;
        }
        
        table { width:100%; border-collapse:collapse; min-width: 600px; } /* Min-width to ensure scroll on small screens */
        th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; font-size:14px; white-space: nowrap; } /* Prevent text wrapping for better mobile view */
        th { background:#f8f9fa; font-weight:600; }
        tr:hover { background:#f8f9fa; }
        
        .badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
        .badge-success { background:#d4edda; color:#155724; }
        .badge-warning { background:#fff3cd; color:#856404; }
        .badge-danger { background:#f8d7da; color:#721c24; }
        
        .back-btn { 
            display:inline-block; padding:10px 20px; background:#007bff; color:#fff; 
            text-decoration:none; border-radius:5px; margin-bottom:20px; 
            transition:background 0.3s ease;
        }
        .back-btn:hover { background:#0056b3; }
        
        @media (max-width:768px) {
            .stats-grid { grid-template-columns:repeat(2, 1fr); }
            .chart-grid { grid-template-columns:1fr; }
            h1 { font-size:1.5rem; }
            .stat-number { font-size:2rem; }
            table { min-width: 500px; } /* Adjust min-width for tablets */
            th, td { padding:10px; font-size:13px; }
        }
        
        @media (max-width:480px) {
            body { padding:10px; }
            .stats-grid { grid-template-columns:1fr; }
            .table-wrapper { margin: 0 -10px 10px -10px; } /* Extend wrapper to edges inside card for full width scroll */
            table { min-width: 400px; } /* Smaller min-width for phones */
            th, td { padding:8px; font-size:12px; }
            .table-card { padding:15px; } /* Reduce card padding on very small screens */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="breadcrumb">
                <a href="{{ url_for('admin_index') }}">Dashboard</a> / Analytics
            </div>
            <h1>üìä Analytics & Statistics</h1>
        </header>
        
        <a href="{{ url_for('admin_index') }}" class="back-btn">‚Üê Kembali ke Beranda</a>
        
        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_siswa }}</div>
                <div class="stat-label">Total Siswa</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.absensi_hari_ini }}</div>
                <div class="stat-label">Hadir Hari Ini</div>
                <div class="stat-change positive">{{ stats.persentase_hari_ini }}% kehadiran</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.belum_absen }}</div>
                <div class="stat-label">Belum Absen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.absensi_minggu_ini }}</div>
                <div class="stat-label">Minggu Ini</div>
                {% if weekly_comp %}
                <div class="stat-change {% if weekly_comp.change >= 0 %}positive{% else %}negative{% endif %}">
                    {% if weekly_comp.change >= 0 %}+{% endif %}{{ weekly_comp.change_percent }}% vs minggu lalu
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Charts -->
        <div class="chart-grid">
            <div class="chart-card">
                <h3>üìà Tren Kehadiran 30 Hari Terakhir</h3>
                <canvas id="trendChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>üìö Kehadiran per Kelas</h3>
                <canvas id="classChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>üéì Kehadiran per Jurusan</h3>
                <canvas id="jurusanChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>‚è∞ Jam Puncak Absensi</h3>
                <canvas id="peakHoursChart"></canvas>
            </div>
        </div>
        
        <!-- Top Students -->
        {% if top_students %}
        <div class="table-card">
            <h3>üèÜ Top 10 Siswa Terajin (30 Hari Terakhir)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>No. Absen</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Jurusan</th>
                            <th>Total Hadir</th>
                            <th>Tepat Waktu</th>
                            <th>Terlambat</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in top_students %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>{{ student.nomor_absen }}</td>
                            <td>{{ student.nama }}</td>
                            <td>{{ student.kelas }}</td>
                            <td>{{ student.jurusan }}</td>
                            <td><span class="badge badge-success">{{ student.total_hadir }}</span></td>
                            <td>{{ student.tepat_waktu }}</td>
                            <td>{{ student.terlambat }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Most Late Students -->
        {% if most_late %}
        <div class="table-card">
            <h3>‚ö†Ô∏è Siswa Paling Sering Terlambat (30 Hari Terakhir)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>No. Absen</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Jurusan</th>
                            <th>Total Terlambat</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in most_late %}
                        <tr>
                            <td>{{ student.nomor_absen }}</td>
                            <td>{{ student.nama }}</td>
                            <td>{{ student.kelas }}</td>
                            <td>{{ student.jurusan }}</td>
                            <td><span class="badge badge-warning">{{ student.total_terlambat }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Absent Today -->
        {% if absent_today %}
        <div class="table-card">
            <h3>‚ùå Siswa Belum Absen Hari Ini ({{ absent_today|length }} Siswa)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>No. Absen</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Jurusan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in absent_today %}
                        <tr>
                            <td>{{ student.nomor_absen }}</td>
                            <td>{{ student.nama }}</td>
                            <td>{{ student.kelas }}</td>
                            <td>{{ student.jurusan }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Class Statistics -->
        <div class="table-card">
            <h3>üìö Statistik per Kelas (Hari Ini)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Kelas</th>
                            <th>Total Siswa</th>
                            <th>Hadir</th>
                            <th>Alpha</th>
                            <th>Persentase</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in class_stats %}
                        <tr>
                            <td><strong>{{ stat.kelas }}</strong></td>
                            <td>{{ stat.total }}</td>
                            <td><span class="badge badge-success">{{ stat.hadir }}</span></td>
                            <td><span class="badge badge-danger">{{ stat.alpha }}</span></td>
                            <td>{{ stat.percentage }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Jurusan Statistics -->
        <div class="table-card">
            <h3>üéì Statistik per Jurusan (Hari Ini)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Jurusan</th>
                            <th>Total Siswa</th>
                            <th>Hadir</th>
                            <th>Alpha</th>
                            <th>Persentase</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in jurusan_stats %}
                        <tr>
                            <td><strong>{{ stat.jurusan }}</strong></td>
                            <td>{{ stat.total }}</td>
                            <td><span class="badge badge-success">{{ stat.hadir }}</span></td>
                            <td><span class="badge badge-danger">{{ stat.alpha }}</span></td>
                            <td>{{ stat.percentage }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Data dari Flask
        const trendData = {{ trend|tojson }};
        const classData = {{ class_stats|tojson }};
        const jurusanData = {{ jurusan_stats|tojson }};
        const peakHoursData = {{ peak_hours|tojson }};
        
        // Trend Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.map(d => d.date),
                datasets: [{
                    label: 'Jumlah Absensi',
                    data: trendData.map(d => d.count),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        // Class Chart
        const classCtx = document.getElementById('classChart').getContext('2d');
        new Chart(classCtx, {
            type: 'bar',
            data: {
                labels: classData.map(d => d.kelas),
                datasets: [{
                    label: 'Hadir',
                    data: classData.map(d => d.hadir),
                    backgroundColor: '#28a745'
                }, {
                    label: 'Alpha',
                    data: classData.map(d => d.alpha),
                    backgroundColor: '#dc3545'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        // Jurusan Chart
        const jurusanCtx = document.getElementById('jurusanChart').getContext('2d');
        new Chart(jurusanCtx, {
            type: 'doughnut',
            data: {
                labels: jurusanData.map(d => d.jurusan),
                datasets: [{
                    data: jurusanData.map(d => d.hadir),
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
        
        // Peak Hours Chart
        const peakCtx = document.getElementById('peakHoursChart').getContext('2d');
        new Chart(peakCtx, {
            type: 'bar',
            data: {
                labels: peakHoursData.map(d => d.hour),
                datasets: [{
                    label: 'Jumlah Absensi',
                    data: peakHoursData.map(d => d.count),
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
</body>
</html>